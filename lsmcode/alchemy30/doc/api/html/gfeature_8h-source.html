<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Alchemy: src/rrf/gfeature.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_bad0962745a374caf6e9fb10c9087375.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_03927fe518ed865627761a1d09ad61c0.html">rrf</a></div>
<h1>gfeature.h</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifndef GFEATURE_H_APR_06</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">#define GFEATURE_H_APR_06</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span>
<a name="l00004"></a>00004 <span class="preprocessor">#include "feature.h"</span>
<a name="l00005"></a>00005 
<a name="l00006"></a><a class="code" href="classGroundFeature.html">00006</a> <span class="keyword">class </span><a class="code" href="classGroundFeature.html">GroundFeature</a>
<a name="l00007"></a>00007 {
<a name="l00008"></a>00008 <span class="keyword">public</span>:
<a name="l00009"></a><a class="code" href="classGroundFeature.html#89ce6dc4f46e28cbbb3af55b4bfcb820">00009</a>     <a class="code" href="classGroundFeature.html#89ce6dc4f46e28cbbb3af55b4bfcb820">GroundFeature</a>()
<a name="l00010"></a>00010         : <a class="code" href="classGroundFeature.html#31a533ff1b3c471327b542499c1a25a6">dirtyDeriv_</a>(true), <a class="code" href="classGroundFeature.html#0c60603d75a0824da112a81772ab3219">dirtyValue_</a>(true), <a class="code" href="classGroundFeature.html#043125ddcec2b9befd1eca5d4a7b6fd2">dirtyLogValue_</a>(true)
<a name="l00011"></a>00011     { <span class="comment">/* NOP */</span> }
<a name="l00012"></a>00012 
<a name="l00013"></a><a class="code" href="classGroundFeature.html#d19db2d9ca228a0ec903f746d51f7e97">00013</a>     <span class="keyword">virtual</span> <a class="code" href="classGroundFeature.html#d19db2d9ca228a0ec903f746d51f7e97">~GroundFeature</a>() { <span class="comment">/* NOP */</span> }
<a name="l00014"></a>00014 
<a name="l00015"></a><a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">00015</a>     <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>() {
<a name="l00016"></a>00016 
<a name="l00017"></a>00017         <span class="keywordflow">if</span> (<a class="code" href="classGroundFeature.html#0c60603d75a0824da112a81772ab3219">dirtyValue_</a>) {
<a name="l00018"></a>00018             <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a> = <a class="code" href="classGroundFeature.html#6d9af22fcdb27a47dbcb1fc11d850bfe">computeValue</a>();
<a name="l00019"></a>00019             <a class="code" href="classGroundFeature.html#0c60603d75a0824da112a81772ab3219">dirtyValue_</a> = <span class="keyword">false</span>;
<a name="l00020"></a>00020         }
<a name="l00021"></a>00021 
<a name="l00022"></a>00022         <span class="keywordflow">return</span> <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a>;
<a name="l00023"></a>00023     }
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="classGroundFeature.html#4312cfdd326ed93cb22bd71f74161689">00025</a>     <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#4312cfdd326ed93cb22bd71f74161689">getLogValue</a>() {
<a name="l00026"></a>00026 
<a name="l00027"></a>00027         <span class="keywordflow">if</span> (<a class="code" href="classGroundFeature.html#043125ddcec2b9befd1eca5d4a7b6fd2">dirtyLogValue_</a>) {
<a name="l00028"></a>00028             <a class="code" href="classGroundFeature.html#85d566806c29bd7d25e6493f734c0c89">cachedLogValue_</a> = <a class="code" href="classGroundFeature.html#6700c690bffadecd5b888a4094340ceb">computeLogValue</a>();
<a name="l00029"></a>00029             <a class="code" href="classGroundFeature.html#043125ddcec2b9befd1eca5d4a7b6fd2">dirtyLogValue_</a> = <span class="keyword">false</span>;
<a name="l00030"></a>00030         }
<a name="l00031"></a>00031         
<a name="l00032"></a>00032         <span class="keywordflow">return</span> <a class="code" href="classGroundFeature.html#85d566806c29bd7d25e6493f734c0c89">cachedLogValue_</a>;
<a name="l00033"></a>00033     }
<a name="l00034"></a>00034 
<a name="l00035"></a><a class="code" href="classGroundFeature.html#08af0bfb8e7f9fdfa8ed5bed564f5d24">00035</a>     <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#08af0bfb8e7f9fdfa8ed5bed564f5d24">getCounts</a>(<span class="keywordtype">int</span> featureIndex, <span class="keywordtype">int</span> weightIndex) {
<a name="l00036"></a>00036         <span class="keywordflow">return</span> <a class="code" href="classGroundFeature.html#a478161b8afb050b6a4c9991af82c882">computePartialDeriv</a>(featureIndex, weightIndex);
<a name="l00037"></a>00037     }
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="classGroundFeature.html#6d9af22fcdb27a47dbcb1fc11d850bfe">00039</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#6d9af22fcdb27a47dbcb1fc11d850bfe">computeValue</a>() { <span class="keywordflow">return</span> 0.0; }
<a name="l00040"></a><a class="code" href="classGroundFeature.html#6700c690bffadecd5b888a4094340ceb">00040</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#6700c690bffadecd5b888a4094340ceb">computeLogValue</a>() { <span class="keywordflow">return</span> 0.0; }
<a name="l00041"></a><a class="code" href="classGroundFeature.html#a478161b8afb050b6a4c9991af82c882">00041</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#a478161b8afb050b6a4c9991af82c882">computePartialDeriv</a>(<span class="keywordtype">int</span> featureIndex, <span class="keywordtype">int</span> weightIndex) 
<a name="l00042"></a>00042         { <span class="keywordflow">return</span> 0.0; }
<a name="l00043"></a>00043 
<a name="l00044"></a>00044     <span class="keyword">inline</span> <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#88545bfad2c34f9af3f0c8897e0dc670">getDeriv</a>();
<a name="l00045"></a>00045 
<a name="l00046"></a>00046     <span class="comment">// This is for computing the partial derivative of a feature with</span>
<a name="l00047"></a>00047     <span class="comment">// respect to a child feature.  It's only relevant for recursive features.</span>
<a name="l00048"></a><a class="code" href="classGroundFeature.html#204f073ab2a75057ba06f8ee4bea759e">00048</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#204f073ab2a75057ba06f8ee4bea759e">getChildDeriv</a>(<span class="keywordtype">int</span> i) {
<a name="l00049"></a>00049         assert(<span class="keyword">false</span>);
<a name="l00050"></a>00050         <span class="keywordflow">return</span> 0.0;
<a name="l00051"></a>00051     }
<a name="l00052"></a>00052 
<a name="l00053"></a>00053     <span class="comment">// Clear cached value/partial derivative</span>
<a name="l00054"></a>00054     <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classGroundFeature.html#925fe3462f91580fde6448ba143196f7">setDirty</a>();
<a name="l00055"></a>00055     
<a name="l00056"></a>00056     <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classGroundFeature.html#4212e0c6b913e0c1e5e1b55271fe5d1f">updateParents</a>(<span class="keywordtype">double</span> oldValue, <span class="keywordtype">double</span> newValue);
<a name="l00057"></a>00057     <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classGroundFeature.html#1085873599a045fd2441ebb3e61e6f8c">updateParentCounts</a>(<span class="keywordtype">double</span> oldValue, <span class="keywordtype">double</span> newValue);
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="classGroundFeature.html#503152f994f7e214f1ccdf47dbb48851">00059</a>     <span class="keywordtype">void</span> <a class="code" href="classGroundFeature.html#503152f994f7e214f1ccdf47dbb48851">addParent</a>(<a class="code" href="classRecursiveGroundFeature.html">RecursiveGroundFeature</a>* parent, <span class="keywordtype">int</span> parentIndex) {
<a name="l00060"></a>00060         <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>.<a class="code" href="classArray.html#752db599431d93ee14c5b0f7b05ba03a">append</a>(parent);
<a name="l00061"></a>00061         <a class="code" href="classGroundFeature.html#e4c8f628b191ba453d5491a56b365a15">parentIndices_</a>.<a class="code" href="classArray.html#752db599431d93ee14c5b0f7b05ba03a">append</a>(parentIndex);
<a name="l00062"></a>00062     }
<a name="l00063"></a>00063     <span class="comment">// TODO: remove parent?  clear parent?</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="keyword">protected</span>:
<a name="l00066"></a><a class="code" href="classGroundFeature.html#31a533ff1b3c471327b542499c1a25a6">00066</a>     <span class="keywordtype">bool</span> <a class="code" href="classGroundFeature.html#31a533ff1b3c471327b542499c1a25a6">dirtyDeriv_</a>;
<a name="l00067"></a><a class="code" href="classGroundFeature.html#0c60603d75a0824da112a81772ab3219">00067</a>     <span class="keywordtype">bool</span> <a class="code" href="classGroundFeature.html#0c60603d75a0824da112a81772ab3219">dirtyValue_</a>;
<a name="l00068"></a><a class="code" href="classGroundFeature.html#043125ddcec2b9befd1eca5d4a7b6fd2">00068</a>     <span class="keywordtype">bool</span> <a class="code" href="classGroundFeature.html#043125ddcec2b9befd1eca5d4a7b6fd2">dirtyLogValue_</a>;
<a name="l00069"></a><a class="code" href="classGroundFeature.html#94858a4e98d9f8adc435d6210095665f">00069</a>     <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#94858a4e98d9f8adc435d6210095665f">cachedDeriv_</a>;
<a name="l00070"></a><a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">00070</a>     <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a>;
<a name="l00071"></a><a class="code" href="classGroundFeature.html#85d566806c29bd7d25e6493f734c0c89">00071</a>     <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#85d566806c29bd7d25e6493f734c0c89">cachedLogValue_</a>;
<a name="l00072"></a><a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">00072</a>     <a class="code" href="classArray.html">Array&lt;RecursiveGroundFeature*&gt;</a> <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>;
<a name="l00073"></a><a class="code" href="classGroundFeature.html#e4c8f628b191ba453d5491a56b365a15">00073</a>     <a class="code" href="classArray.html">Array&lt;int&gt;</a> <a class="code" href="classGroundFeature.html#e4c8f628b191ba453d5491a56b365a15">parentIndices_</a>;
<a name="l00074"></a>00074 };
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 
<a name="l00077"></a><a class="code" href="classRecursiveGroundFeature.html">00077</a> <span class="keyword">class </span><a class="code" href="classRecursiveGroundFeature.html">RecursiveGroundFeature</a> : <span class="keyword">public</span> <a class="code" href="classGroundFeature.html">GroundFeature</a>
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079 <span class="keyword">public</span>:
<a name="l00080"></a><a class="code" href="classRecursiveGroundFeature.html#e4b0db63327ddc9e21085bf29e3f11f1">00080</a>     <a class="code" href="classRecursiveGroundFeature.html#e4b0db63327ddc9e21085bf29e3f11f1">RecursiveGroundFeature</a>(<a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>* featureTemplate, 
<a name="l00081"></a>00081             <span class="keywordtype">bool</span> doDerivsOfLog=<span class="keyword">false</span>)
<a name="l00082"></a>00082         : <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>(featureTemplate), <a class="code" href="classRecursiveGroundFeature.html#dae6216a07eb4154133273d90d8057c5">doDerivsOfLog_</a>(doDerivsOfLog)
<a name="l00083"></a>00083     { <span class="comment">/* NOP */</span> }
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="classRecursiveGroundFeature.html#4d9867786b94ce6ba3f8c54f8b64d54b">00085</a>     <span class="keyword">virtual</span> <a class="code" href="classRecursiveGroundFeature.html#4d9867786b94ce6ba3f8c54f8b64d54b">~RecursiveGroundFeature</a>() { <span class="comment">/* NOP */</span> }
<a name="l00086"></a>00086 
<a name="l00087"></a><a class="code" href="classRecursiveGroundFeature.html#fe55b9841df250b3317ffbbcb58ca764">00087</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRecursiveGroundFeature.html#fe55b9841df250b3317ffbbcb58ca764">computeValue</a>()
<a name="l00088"></a>00088     {
<a name="l00089"></a>00089 <span class="preprocessor">#if SIGMOID</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span>        <a class="code" href="classRecursiveGroundFeature.html#ea6bd02187345b5ae99f217b297e96cd">computeLogValue</a>();
<a name="l00091"></a>00091         <span class="keywordflow">return</span> sigmoid(<a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a>);
<a name="l00092"></a>00092 <span class="preprocessor">#else</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span>        <span class="keywordflow">return</span> exp(<a class="code" href="classRecursiveGroundFeature.html#ea6bd02187345b5ae99f217b297e96cd">computeLogValue</a>());
<a name="l00094"></a>00094 <span class="preprocessor">#endif</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>    }
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="classRecursiveGroundFeature.html#ea6bd02187345b5ae99f217b297e96cd">00097</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRecursiveGroundFeature.html#ea6bd02187345b5ae99f217b297e96cd">computeLogValue</a>()
<a name="l00098"></a>00098     {
<a name="l00099"></a>00099         <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> = 0.0;
<a name="l00100"></a>00100         <a class="code" href="classRecursiveGroundFeature.html#d4c44a9c6e568d83057698de09657c99">subSums_</a>.<a class="code" href="classArray.html#a8417f3aab7a56eee773c45173c77626">growToSize</a>(<a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>());
<a name="l00101"></a>00101 
<a name="l00102"></a>00102         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); i++) {
<a name="l00103"></a>00103             <span class="keywordtype">double</span> currFeatureTotal = 0.0;
<a name="l00104"></a>00104             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[i].<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); j++) {
<a name="l00105"></a>00105                 <span class="comment">//cout &lt;&lt; children_[i][j]-&gt;getLogValue() &lt;&lt; endl;</span>
<a name="l00106"></a>00106                 <span class="comment">//cout &lt;&lt; children_[i][j]-&gt;getValue() &lt;&lt; endl;</span>
<a name="l00107"></a>00107                 currFeatureTotal += <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[i][j]-&gt;<a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>();
<a name="l00108"></a>00108             }
<a name="l00109"></a>00109 <span class="preprocessor">#if NORM</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span>            <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> += <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(i) * currFeatureTotal 
<a name="l00111"></a>00111                 / <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[i].<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); <span class="comment">// Normalize by the number of groundings</span>
<a name="l00112"></a>00112 <span class="preprocessor">#else</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span>            <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> += <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(i) * currFeatureTotal;
<a name="l00114"></a>00114 <span class="preprocessor">#endif</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span>            <a class="code" href="classRecursiveGroundFeature.html#d4c44a9c6e568d83057698de09657c99">subSums_</a>[i] = currFeatureTotal;
<a name="l00116"></a>00116         }
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         <a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>* recFeature = (<a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>*)<a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>;
<a name="l00119"></a>00119         <span class="comment">// DEBUG</span>
<a name="l00120"></a>00120         <span class="comment">//cout &lt;&lt; featureTemplate_-&gt;getId() &lt;&lt; endl;</span>
<a name="l00121"></a>00121         <span class="comment">//cout &lt;&lt; "cachedSum_ = " &lt;&lt; cachedSum_ &lt;&lt; endl;</span>
<a name="l00122"></a>00122         <span class="keywordflow">return</span> <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> - recFeature-&gt;<a class="code" href="classRecursiveFeature.html#ddb85e7cd4a2c28e3898d0952b7cabab">getLogZ</a>();
<a name="l00123"></a>00123     }
<a name="l00124"></a>00124 
<a name="l00125"></a><a class="code" href="classRecursiveGroundFeature.html#263a4730444f52e84b618f9624ccb856">00125</a>     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classRecursiveGroundFeature.html#263a4730444f52e84b618f9624ccb856">update</a>(<span class="keywordtype">int</span> idx, <span class="keywordtype">double</span> oldValue, <span class="keywordtype">double</span> newValue)
<a name="l00126"></a>00126     {
<a name="l00127"></a>00127         <a class="code" href="classGroundFeature.html#31a533ff1b3c471327b542499c1a25a6">dirtyDeriv_</a> = <span class="keyword">true</span>;
<a name="l00128"></a>00128         <span class="comment">// TODO -- what's the right way to do this?  Possible bug.</span>
<a name="l00129"></a>00129         <span class="keywordflow">if</span> (!<a class="code" href="classGroundFeature.html#0c60603d75a0824da112a81772ab3219">dirtyValue_</a> || !<a class="code" href="classGroundFeature.html#043125ddcec2b9befd1eca5d4a7b6fd2">dirtyLogValue_</a>) {
<a name="l00130"></a>00130             <span class="keywordtype">double</span> oldCachedValue = <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a>;
<a name="l00131"></a>00131 <span class="preprocessor">#if NORM</span>
<a name="l00132"></a>00132 <span class="preprocessor"></span>            <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> += <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(idx) 
<a name="l00133"></a>00133                 * (newValue - oldValue)
<a name="l00134"></a>00134                 /<a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[idx].size(); <span class="comment">// Normalize by number of children</span>
<a name="l00135"></a>00135 <span class="preprocessor">#else</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span>            <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> += <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(idx) 
<a name="l00137"></a>00137                 * (newValue - oldValue);
<a name="l00138"></a>00138 <span class="preprocessor">#endif</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>            <a class="code" href="classRecursiveGroundFeature.html#d4c44a9c6e568d83057698de09657c99">subSums_</a>[idx] += newValue - oldValue;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141             <a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>* recFeature = (<a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>*)<a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>;
<a name="l00142"></a>00142             <a class="code" href="classGroundFeature.html#85d566806c29bd7d25e6493f734c0c89">cachedLogValue_</a> = <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> - recFeature-&gt;<a class="code" href="classRecursiveFeature.html#ddb85e7cd4a2c28e3898d0952b7cabab">getLogZ</a>();
<a name="l00143"></a>00143 <span class="preprocessor">#if SIGMOID</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span>            <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a> = sigmoid(<a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a>);
<a name="l00145"></a>00145 <span class="preprocessor">#else</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>            <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a> = exp(<a class="code" href="classGroundFeature.html#85d566806c29bd7d25e6493f734c0c89">cachedLogValue_</a>);
<a name="l00147"></a>00147 <span class="preprocessor">#endif</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span>            <a class="code" href="classGroundFeature.html#4212e0c6b913e0c1e5e1b55271fe5d1f">updateParents</a>(oldCachedValue, <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a>);
<a name="l00149"></a>00149         }
<a name="l00150"></a>00150     }
<a name="l00151"></a>00151 
<a name="l00152"></a><a class="code" href="classRecursiveGroundFeature.html#57bcac11584f7d3949e1d1d0f9f75a6b">00152</a>     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classRecursiveGroundFeature.html#57bcac11584f7d3949e1d1d0f9f75a6b">updateCounts</a>(<span class="keywordtype">int</span> idx, <span class="keywordtype">double</span> oldValue, <span class="keywordtype">double</span> newValue)
<a name="l00153"></a>00153     {
<a name="l00154"></a>00154         <span class="keywordflow">if</span> ((<a class="code" href="classGroundFeature.html#0c60603d75a0824da112a81772ab3219">dirtyValue_</a> &amp;&amp; <a class="code" href="classGroundFeature.html#043125ddcec2b9befd1eca5d4a7b6fd2">dirtyLogValue_</a>) || <a class="code" href="classGroundFeature.html#31a533ff1b3c471327b542499c1a25a6">dirtyDeriv_</a>) {
<a name="l00155"></a>00155            cout &lt;&lt; <span class="stringliteral">"ERROR: cache must be up-to-date when calling "</span>
<a name="l00156"></a>00156                &lt;&lt; <span class="stringliteral">"updateCounts!\n"</span>;
<a name="l00157"></a>00157            <span class="keywordflow">return</span>;
<a name="l00158"></a>00158         }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160         <span class="keywordtype">double</span> counts = <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classFeature.html#d11536f29fbf2f22e815e018fa34d688">getCount</a>(idx);
<a name="l00161"></a>00161         <span class="comment">//int id = featureTemplate_-&gt;getId();</span>
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         <span class="comment">// Figure out what the partial derivative with respect</span>
<a name="l00164"></a>00164         <span class="comment">// to the idx'd weight used to be</span>
<a name="l00165"></a>00165         <span class="keywordtype">double</span> totalPartial = 0.0;
<a name="l00166"></a>00166         {
<a name="l00167"></a>00167 <span class="preprocessor">#if 0</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span>            <span class="comment">// HACK DEBUG -- verify that our nubmers are consistent here</span>
<a name="l00169"></a>00169             <span class="keywordtype">double</span> totalValue = 0.0;
<a name="l00170"></a>00170             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> w = 0; w &lt; <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); w++) {
<a name="l00171"></a>00171                 <span class="keywordtype">double</span> sum = 0.0;
<a name="l00172"></a>00172                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[w].<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); j++) {
<a name="l00173"></a>00173                     sum += <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[w][j]-&gt;<a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>();
<a name="l00174"></a>00174                 }
<a name="l00175"></a>00175                 totalValue += sum * <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(w);
<a name="l00176"></a>00176             }
<a name="l00177"></a>00177             cout &lt;&lt; <span class="stringliteral">"Old:      "</span> &lt;&lt; <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> &lt;&lt; endl;
<a name="l00178"></a>00178             cout &lt;&lt; <span class="stringliteral">"New:      "</span> &lt;&lt; totalValue &lt;&lt; endl;
<a name="l00179"></a>00179             totalValue += (oldValue - newValue) 
<a name="l00180"></a>00180                 * <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(idx);
<a name="l00181"></a>00181             cout &lt;&lt; <span class="stringliteral">"Computed: "</span> &lt;&lt; totalValue &lt;&lt; endl;
<a name="l00182"></a>00182             <span class="comment">// END CONSISTENCY CHECK</span>
<a name="l00183"></a>00183 <span class="preprocessor">#endif</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>
<a name="l00185"></a>00185             <a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>* recTemplate 
<a name="l00186"></a>00186                 = (<a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>*)<a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>;
<a name="l00187"></a>00187             totalPartial = <a class="code" href="classRecursiveGroundFeature.html#d4c44a9c6e568d83057698de09657c99">subSums_</a>[idx] - recTemplate-&gt;<a class="code" href="classRecursiveFeature.html#0bc8d6ac391478f3537cefeb4dc5eaa9">getNorm</a>(idx);
<a name="l00188"></a>00188             
<a name="l00189"></a>00189             <span class="keywordflow">if</span> (!<a class="code" href="classRecursiveGroundFeature.html#dae6216a07eb4154133273d90d8057c5">doDerivsOfLog_</a>) {
<a name="l00190"></a>00190 <span class="preprocessor">#if SIGMOID</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span>                totalPartial *= <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>() * (1.0 - <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>());
<a name="l00192"></a>00192 <span class="preprocessor">#else</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span>                totalPartial *= <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>();
<a name="l00194"></a>00194 <span class="preprocessor">#endif</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>            }
<a name="l00196"></a>00196             <span class="comment">//cout &lt;&lt; "totalPartial(sum2) = " &lt;&lt; totalPartial &lt;&lt; endl;</span>
<a name="l00197"></a>00197         }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199         <span class="comment">// DEBUG</span>
<a name="l00200"></a>00200         <span class="comment">//cout &lt;&lt; "deriv = " &lt;&lt; cachedDeriv_ &lt;&lt; endl;</span>
<a name="l00201"></a>00201         <span class="comment">//cout &lt;&lt; "oldcounts = " &lt;&lt; counts &lt;&lt; endl;</span>
<a name="l00202"></a>00202 
<a name="l00203"></a>00203         <span class="comment">// Use it to subtract old counts </span>
<a name="l00204"></a>00204         <span class="comment">// (using old derivative and old partial derivative here)</span>
<a name="l00205"></a>00205         counts -= <a class="code" href="classGroundFeature.html#94858a4e98d9f8adc435d6210095665f">cachedDeriv_</a> * totalPartial;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207         <span class="comment">// DEBUG</span>
<a name="l00208"></a>00208         <span class="comment">//cout &lt;&lt; "newcounts = " &lt;&lt; counts &lt;&lt; endl;</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <span class="comment">// Update value</span>
<a name="l00211"></a>00211         <span class="keywordtype">double</span> oldCachedValue = <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a>;
<a name="l00212"></a>00212         <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> += <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(idx) 
<a name="l00213"></a>00213             * (newValue - oldValue);
<a name="l00214"></a>00214         <a class="code" href="classRecursiveGroundFeature.html#d4c44a9c6e568d83057698de09657c99">subSums_</a>[idx] += newValue - oldValue;
<a name="l00215"></a>00215 
<a name="l00216"></a>00216         <a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>* recFeature = (<a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>*)<a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>;
<a name="l00217"></a>00217         <a class="code" href="classGroundFeature.html#85d566806c29bd7d25e6493f734c0c89">cachedLogValue_</a> = <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> - recFeature-&gt;<a class="code" href="classRecursiveFeature.html#ddb85e7cd4a2c28e3898d0952b7cabab">getLogZ</a>();
<a name="l00218"></a>00218 <span class="preprocessor">#if SIGMOID</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span>        <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a> = sigmoid(<a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a>);
<a name="l00220"></a>00220 <span class="preprocessor">#else</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span>        <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a> = exp(<a class="code" href="classGroundFeature.html#85d566806c29bd7d25e6493f734c0c89">cachedLogValue_</a>);
<a name="l00222"></a>00222 <span class="preprocessor">#endif</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>        
<a name="l00224"></a>00224         <span class="comment">// Update parent values (and derivatives)</span>
<a name="l00225"></a>00225         <a class="code" href="classGroundFeature.html#1085873599a045fd2441ebb3e61e6f8c">updateParentCounts</a>(oldCachedValue, <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a>);
<a name="l00226"></a>00226 
<a name="l00227"></a>00227         <span class="comment">// Update our derivative (depends on parent derivs)</span>
<a name="l00228"></a>00228         <a class="code" href="classGroundFeature.html#94858a4e98d9f8adc435d6210095665f">cachedDeriv_</a> = 0.0;
<a name="l00229"></a>00229         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); i++) {
<a name="l00230"></a>00230             <a class="code" href="classGroundFeature.html#94858a4e98d9f8adc435d6210095665f">cachedDeriv_</a> += <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>[i]-&gt;<a class="code" href="classGroundFeature.html#88545bfad2c34f9af3f0c8897e0dc670">getDeriv</a>()
<a name="l00231"></a>00231                 * <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>[i]-&gt;getChildDeriv(<a class="code" href="classGroundFeature.html#e4c8f628b191ba453d5491a56b365a15">parentIndices_</a>[i]);
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234         <span class="keywordflow">if</span> (<a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>() == 0.0) {
<a name="l00235"></a>00235             <a class="code" href="classGroundFeature.html#94858a4e98d9f8adc435d6210095665f">cachedDeriv_</a> = 1.0;
<a name="l00236"></a>00236         }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238         <span class="comment">// Add in updated counts</span>
<a name="l00239"></a>00239         {
<a name="l00240"></a>00240             <a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>* recTemplate 
<a name="l00241"></a>00241                 = (<a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>*)<a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>;
<a name="l00242"></a>00242             totalPartial = <a class="code" href="classRecursiveGroundFeature.html#d4c44a9c6e568d83057698de09657c99">subSums_</a>[idx] - recTemplate-&gt;<a class="code" href="classRecursiveFeature.html#0bc8d6ac391478f3537cefeb4dc5eaa9">getNorm</a>(idx);
<a name="l00243"></a>00243             
<a name="l00244"></a>00244             <span class="keywordflow">if</span> (!<a class="code" href="classRecursiveGroundFeature.html#dae6216a07eb4154133273d90d8057c5">doDerivsOfLog_</a>) {
<a name="l00245"></a>00245 <span class="preprocessor">#if SIGMOID</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span>                totalPartial *= <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>() * (1.0 - <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>());
<a name="l00247"></a>00247 <span class="preprocessor">#else</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span>                totalPartial *= <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>();
<a name="l00249"></a>00249 <span class="preprocessor">#endif</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span>            }
<a name="l00251"></a>00251         }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253         counts += <a class="code" href="classGroundFeature.html#94858a4e98d9f8adc435d6210095665f">cachedDeriv_</a> * totalPartial;
<a name="l00254"></a>00254         <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classFeature.html#7072f294d93636f5712731e5d1b996ce">setCount</a>(idx,counts);
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257 
<a name="l00258"></a><a class="code" href="classRecursiveGroundFeature.html#03e319ef4d1cbf8d01462202257d67c7">00258</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRecursiveGroundFeature.html#03e319ef4d1cbf8d01462202257d67c7">getChildDeriv</a>(<span class="keywordtype">int</span> i)
<a name="l00259"></a>00259     {
<a name="l00260"></a>00260         <span class="keywordtype">double</span> totalPartial = <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(i);
<a name="l00261"></a>00261 <span class="preprocessor">#if NORM</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span>        totalPartial /= <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[i].<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>();
<a name="l00263"></a>00263 <span class="preprocessor">#endif</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span>
<a name="l00265"></a>00265         <span class="keywordflow">if</span> (<a class="code" href="classRecursiveGroundFeature.html#dae6216a07eb4154133273d90d8057c5">doDerivsOfLog_</a>) {
<a name="l00266"></a>00266             <span class="keywordflow">return</span> totalPartial;
<a name="l00267"></a>00267         } <span class="keywordflow">else</span> {
<a name="l00268"></a>00268             <span class="keywordflow">return</span> <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>() * totalPartial;
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00272"></a><a class="code" href="classRecursiveGroundFeature.html#3f742274ab9787f5b45a9e4310135553">00272</a>     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classRecursiveGroundFeature.html#3f742274ab9787f5b45a9e4310135553">addChild</a>(<span class="keywordtype">int</span> childIndex, <a class="code" href="classGroundFeature.html">GroundFeature</a>* child)
<a name="l00273"></a>00273     {
<a name="l00274"></a>00274         <span class="keywordflow">while</span> (<a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>() &lt;= childIndex) {
<a name="l00275"></a>00275             <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>.<a class="code" href="classArray.html#752db599431d93ee14c5b0f7b05ba03a">append</a>(<a class="code" href="classArray.html">Array&lt;GroundFeature*&gt;</a>());
<a name="l00276"></a>00276         }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[childIndex].<a class="code" href="classArray.html#752db599431d93ee14c5b0f7b05ba03a">append</a>(child);
<a name="l00279"></a>00279         child-&gt;<a class="code" href="classGroundFeature.html#503152f994f7e214f1ccdf47dbb48851">addParent</a>(<span class="keyword">this</span>, childIndex);
<a name="l00280"></a>00280     }
<a name="l00281"></a>00281 
<a name="l00282"></a><a class="code" href="classRecursiveGroundFeature.html#99d3082d1affb48e7e41bf52e241bd9b">00282</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRecursiveGroundFeature.html#99d3082d1affb48e7e41bf52e241bd9b">computePartialDeriv</a>(<span class="keywordtype">int</span> fi, <span class="keywordtype">int</span> wi) 
<a name="l00283"></a>00283     {
<a name="l00284"></a>00284         <span class="keywordtype">double</span> totalPartial = 0.0;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286         <span class="keywordflow">if</span> (fi == <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classFeature.html#e9acf2ede80f4c8cadb5ad78ef61f3ba">getId</a>()) {
<a name="l00287"></a>00287 
<a name="l00288"></a>00288             <span class="keywordflow">if</span> (<a class="code" href="classGroundFeature.html#043125ddcec2b9befd1eca5d4a7b6fd2">dirtyLogValue_</a> &amp;&amp; <a class="code" href="classGroundFeature.html#0c60603d75a0824da112a81772ab3219">dirtyValue_</a>) {
<a name="l00289"></a>00289                 <a class="code" href="classRecursiveGroundFeature.html#ea6bd02187345b5ae99f217b297e96cd">computeLogValue</a>();
<a name="l00290"></a>00290             }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292             <a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>* recTemplate 
<a name="l00293"></a>00293                 = (<a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>*)<a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>;
<a name="l00294"></a>00294             totalPartial = <a class="code" href="classRecursiveGroundFeature.html#d4c44a9c6e568d83057698de09657c99">subSums_</a>[wi] - recTemplate-&gt;<a class="code" href="classRecursiveFeature.html#0bc8d6ac391478f3537cefeb4dc5eaa9">getNorm</a>(wi);
<a name="l00295"></a>00295 <span class="preprocessor">#if NORM</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span>            totalPartial /= <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[wi].<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); <span class="comment">// Normalize by number of groundings</span>
<a name="l00297"></a>00297 <span class="preprocessor">#endif</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
<a name="l00299"></a>00299 
<a name="l00300"></a>00300             <span class="comment">// We should no longer be using this code!</span>
<a name="l00301"></a>00301             assert(<span class="keyword">false</span>);
<a name="l00302"></a>00302 
<a name="l00303"></a>00303             <span class="comment">// Sum partial derivatives for each grounding of each child,</span>
<a name="l00304"></a>00304             <span class="comment">// according to the chain rule of partial derivatives.</span>
<a name="l00305"></a>00305             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); i++) 
<a name="l00306"></a>00306             {
<a name="l00307"></a>00307                 <span class="keywordtype">double</span> featureTotal = 0.0;
<a name="l00308"></a>00308                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[i].<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); j++) {
<a name="l00309"></a>00309                     featureTotal += <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[i][j]-&gt;<a class="code" href="classGroundFeature.html#08af0bfb8e7f9fdfa8ed5bed564f5d24">getCounts</a>(fi, wi);
<a name="l00310"></a>00310                 }
<a name="l00311"></a>00311 <span class="preprocessor">#if NORM</span>
<a name="l00312"></a>00312 <span class="preprocessor"></span>                totalPartial += featureTotal * <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(i)
<a name="l00313"></a>00313                     / <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[i].<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); <span class="comment">// Normalize by number of groundings</span>
<a name="l00314"></a>00314 <span class="preprocessor">#else</span>
<a name="l00315"></a>00315 <span class="preprocessor"></span>                totalPartial += featureTotal * <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(i);
<a name="l00316"></a>00316 <span class="preprocessor">#endif</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span>            }
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320         <span class="keywordflow">if</span> (<a class="code" href="classRecursiveGroundFeature.html#dae6216a07eb4154133273d90d8057c5">doDerivsOfLog_</a>) {
<a name="l00321"></a>00321             <span class="keywordflow">return</span> totalPartial;
<a name="l00322"></a>00322         } <span class="keywordflow">else</span> {
<a name="l00323"></a>00323 <span class="preprocessor">#if SIGMOID</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>() * (1.0 - <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>()) * totalPartial;
<a name="l00325"></a>00325 <span class="preprocessor">#else</span>
<a name="l00326"></a>00326 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>() * totalPartial;
<a name="l00327"></a>00327 <span class="preprocessor">#endif</span>
<a name="l00328"></a>00328 <span class="preprocessor"></span>        }
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 <span class="keyword">protected</span>:
<a name="l00332"></a><a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">00332</a>     <a class="code" href="classArray.html">Array&lt;Array&lt;GroundFeature*&gt;</a> &gt; <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>;
<a name="l00333"></a><a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">00333</a>     <a class="code" href="classRecursiveFeature.html">RecursiveFeature</a>* <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>;
<a name="l00334"></a><a class="code" href="classRecursiveGroundFeature.html#dae6216a07eb4154133273d90d8057c5">00334</a>     <span class="keywordtype">bool</span> <a class="code" href="classRecursiveGroundFeature.html#dae6216a07eb4154133273d90d8057c5">doDerivsOfLog_</a>;
<a name="l00335"></a><a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">00335</a>     <span class="keywordtype">double</span> <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a>;
<a name="l00336"></a><a class="code" href="classRecursiveGroundFeature.html#d4c44a9c6e568d83057698de09657c99">00336</a>     <a class="code" href="classArray.html">Array&lt;double&gt;</a> <a class="code" href="classRecursiveGroundFeature.html#d4c44a9c6e568d83057698de09657c99">subSums_</a>;
<a name="l00337"></a>00337 };
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 
<a name="l00340"></a><a class="code" href="classClausalGroundFeature.html">00340</a> <span class="keyword">class </span><a class="code" href="classClausalGroundFeature.html">ClausalGroundFeature</a> : <span class="keyword">public</span> <a class="code" href="classRecursiveGroundFeature.html">RecursiveGroundFeature</a>
<a name="l00341"></a>00341 {
<a name="l00342"></a>00342 <span class="keyword">public</span>:
<a name="l00343"></a><a class="code" href="classClausalGroundFeature.html#9620d0eb232a02e17609eede6ef1c9aa">00343</a>     <a class="code" href="classClausalGroundFeature.html#9620d0eb232a02e17609eede6ef1c9aa">ClausalGroundFeature</a>(<a class="code" href="classClausalFeature.html">ClausalFeature</a>* featureTemplate)
<a name="l00344"></a>00344         : <a class="code" href="classRecursiveGroundFeature.html">RecursiveGroundFeature</a>(featureTemplate)
<a name="l00345"></a>00345     { <span class="comment">/* NOP */</span> }
<a name="l00346"></a>00346 
<a name="l00347"></a><a class="code" href="classClausalGroundFeature.html#8ee34fdcc8633ba504829c54f2fa2fb3">00347</a>     <span class="keyword">virtual</span> <a class="code" href="classClausalGroundFeature.html#8ee34fdcc8633ba504829c54f2fa2fb3">~ClausalGroundFeature</a>() { <span class="comment">/* NOP */</span> }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 <span class="preprocessor">#if 0</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span>    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRecursiveGroundFeature.html#ea6bd02187345b5ae99f217b297e96cd">computeLogValue</a>() {
<a name="l00351"></a>00351         <span class="comment">// TODO -- fix this!</span>
<a name="l00352"></a>00352         assert(<span class="keyword">false</span>);
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354 <span class="preprocessor">#endif</span>
<a name="l00355"></a>00355 <span class="preprocessor"></span>
<a name="l00356"></a>00356     <span class="comment">// TODO -- implement computeLogValue()</span>
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 <span class="preprocessor">#if 0 // TODO: add subSums_ to this, or something.</span>
<a name="l00359"></a>00359 <span class="preprocessor"></span>    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRecursiveGroundFeature.html#fe55b9841df250b3317ffbbcb58ca764">computeValue</a>() {
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> = 0.0;
<a name="l00362"></a>00362         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); i++) {
<a name="l00363"></a>00363             <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> += <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(i) 
<a name="l00364"></a>00364                 * <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[i][0]-&gt;getValue();
<a name="l00365"></a>00365         }
<a name="l00366"></a>00366 <span class="preprocessor">#if SIGMOID</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span>        <span class="keywordflow">return</span> sigmoid(<a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a>);
<a name="l00368"></a>00368 <span class="preprocessor">#else</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span>        <a class="code" href="classClausalFeature.html">ClausalFeature</a>* clausalTemplate = (<a class="code" href="classClausalFeature.html">ClausalFeature</a>*)<a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>;
<a name="l00370"></a>00370         <span class="keywordflow">return</span> exp(<a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> - clausalTemplate-&gt;<a class="code" href="classClausalFeature.html#ecde4f898b2a5daa0cf6c77aa2297e29">getLogZ</a>());
<a name="l00371"></a>00371 <span class="preprocessor">#endif</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span>    }
<a name="l00373"></a>00373 <span class="preprocessor">#endif</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span>    
<a name="l00375"></a>00375 <span class="preprocessor">#if 0</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span>    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRecursiveGroundFeature.html#03e319ef4d1cbf8d01462202257d67c7">getChildDeriv</a>(<span class="keywordtype">int</span> i)
<a name="l00377"></a>00377     {
<a name="l00378"></a>00378         <span class="comment">// NOTE: this should never actually get called, since the only </span>
<a name="l00379"></a>00379         <span class="comment">// children are predicate features that have no parameters.</span>
<a name="l00380"></a>00380         <span class="comment">// But if there were children with paramters, this is how the</span>
<a name="l00381"></a>00381         <span class="comment">// method should be implemented.</span>
<a name="l00382"></a>00382         assert(<span class="keyword">false</span>);
<a name="l00383"></a>00383         <span class="keywordtype">double</span> weight_i = <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(i);
<a name="l00384"></a>00384         <span class="keywordtype">double</span> ret = <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>() * (weight_i - 
<a name="l00385"></a>00385                 - 1.0/(1.0 + exp(-<a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[i][0]-&gt;<a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>())));
<a name="l00386"></a>00386         <span class="keywordflow">return</span> ret;
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRecursiveGroundFeature.html#99d3082d1affb48e7e41bf52e241bd9b">computePartialDeriv</a>(<span class="keywordtype">int</span> fi, <span class="keywordtype">int</span> wi) 
<a name="l00390"></a>00390     {
<a name="l00391"></a>00391         <a class="code" href="classClausalFeature.html">ClausalFeature</a>* clausalTemplate = (<a class="code" href="classClausalFeature.html">ClausalFeature</a>*)<a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         <span class="keywordflow">if</span> (fi != clausalTemplate-&gt;<a class="code" href="classFeature.html#e9acf2ede80f4c8cadb5ad78ef61f3ba">getId</a>()) {
<a name="l00394"></a>00394             <span class="keywordflow">return</span> 0.0;
<a name="l00395"></a>00395         }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         assert(<a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[wi].size() == 1);
<a name="l00398"></a>00398 <span class="preprocessor">#if SIGMOID</span>
<a name="l00399"></a>00399 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>() * (1.0 - <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>()) 
<a name="l00400"></a>00400             * <a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[wi][0]-&gt;<a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>();
<a name="l00401"></a>00401 <span class="preprocessor">#else</span>
<a name="l00402"></a>00402 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>() * (<a class="code" href="classRecursiveGroundFeature.html#23215510da2245495b9742ff022e374c">children_</a>[wi][0]-&gt;getValue() - 
<a name="l00403"></a>00403                 clausalTemplate-&gt;<a class="code" href="classClausalFeature.html#e37f732a51b252f3e499bd2e832ff20a">getNorm</a>(wi));
<a name="l00404"></a>00404 <span class="preprocessor">#endif</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span>    }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classRecursiveGroundFeature.html#263a4730444f52e84b618f9624ccb856">update</a>(<span class="keywordtype">int</span> idx, <span class="keywordtype">double</span> oldValue, <span class="keywordtype">double</span> newValue)
<a name="l00408"></a>00408     {
<a name="l00409"></a>00409         <a class="code" href="classGroundFeature.html#31a533ff1b3c471327b542499c1a25a6">dirtyDeriv_</a> = <span class="keyword">true</span>;
<a name="l00410"></a>00410         <span class="keywordflow">if</span> (!<a class="code" href="classGroundFeature.html#0c60603d75a0824da112a81772ab3219">dirtyValue_</a>) {
<a name="l00411"></a>00411             <span class="keywordtype">double</span> oldCachedValue = <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a>;
<a name="l00412"></a>00412 <span class="preprocessor">#if 0</span>
<a name="l00413"></a>00413 <span class="preprocessor"></span>            <span class="keywordtype">double</span> oldCachedSum = <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a>;
<a name="l00414"></a>00414 <span class="preprocessor">#endif</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>            <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> += <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(idx) 
<a name="l00416"></a>00416                 * (newValue - oldValue);
<a name="l00417"></a>00417 <span class="preprocessor">#if SIGMOID</span>
<a name="l00418"></a>00418 <span class="preprocessor"></span>            <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a> = sigmoid(<a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a>);
<a name="l00419"></a>00419 <span class="preprocessor">#else</span>
<a name="l00420"></a>00420 <span class="preprocessor"></span>            <a class="code" href="classClausalFeature.html">ClausalFeature</a>* clausalTemplate = 
<a name="l00421"></a>00421                 (<a class="code" href="classClausalFeature.html">ClausalFeature</a>*) <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>;
<a name="l00422"></a>00422             <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a> = exp(<a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> - clausalTemplate-&gt;<a class="code" href="classClausalFeature.html#ecde4f898b2a5daa0cf6c77aa2297e29">getLogZ</a>());
<a name="l00423"></a>00423 <span class="preprocessor">#endif</span>
<a name="l00424"></a>00424 <span class="preprocessor"></span><span class="preprocessor">#if 0</span>
<a name="l00425"></a>00425 <span class="preprocessor"></span>            <span class="keywordtype">double</span> ourCachedSum_ = <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a>;
<a name="l00426"></a>00426             <a class="code" href="classRecursiveGroundFeature.html#fe55b9841df250b3317ffbbcb58ca764">computeValue</a>();
<a name="l00427"></a>00427             <span class="keywordflow">if</span> (fabs(ourCachedSum_ - <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a>) &gt; 0.00001) {
<a name="l00428"></a>00428                 cout &lt;&lt; <span class="stringliteral">"Sums are different!\n"</span>;
<a name="l00429"></a>00429                 cout &lt;&lt; ourCachedSum_ &lt;&lt; endl;
<a name="l00430"></a>00430                 cout &lt;&lt; <a class="code" href="classRecursiveGroundFeature.html#222638c5b0b0a986d541441870540eaa">cachedSum_</a> &lt;&lt; endl;
<a name="l00431"></a>00431                 cout &lt;&lt; <span class="stringliteral">"Old: "</span> &lt;&lt; oldCachedSum &lt;&lt; endl;
<a name="l00432"></a>00432                 cout &lt;&lt; oldValue &lt;&lt; <span class="stringliteral">" -&gt; "</span> &lt;&lt; newValue &lt;&lt; endl;
<a name="l00433"></a>00433                 cout &lt;&lt; <a class="code" href="classRecursiveGroundFeature.html#50d1268eab1634fc87e6ef3ecbe82711">featureTemplate_</a>-&gt;<a class="code" href="classRecursiveFeature.html#48401b041612c2f1999019bcb307429b">getWeight</a>(idx) &lt;&lt; endl;
<a name="l00434"></a>00434             }
<a name="l00435"></a>00435 <span class="preprocessor">#endif</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span>            <a class="code" href="classGroundFeature.html#4212e0c6b913e0c1e5e1b55271fe5d1f">updateParents</a>(oldCachedValue, <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a>);
<a name="l00437"></a>00437         } 
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439 <span class="preprocessor">#endif</span>
<a name="l00440"></a>00440 <span class="preprocessor"></span>};
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 
<a name="l00443"></a><a class="code" href="classPredicateGroundFeature.html">00443</a> <span class="keyword">class </span><a class="code" href="classPredicateGroundFeature.html">PredicateGroundFeature</a> : <span class="keyword">public</span> <a class="code" href="classGroundFeature.html">GroundFeature</a>
<a name="l00444"></a>00444 {
<a name="l00445"></a>00445 <span class="keyword">public</span>:
<a name="l00446"></a><a class="code" href="classPredicateGroundFeature.html#590b6e4cdbbf043db13653cfcccd0a74">00446</a>     <a class="code" href="classPredicateGroundFeature.html#590b6e4cdbbf043db13653cfcccd0a74">PredicateGroundFeature</a>(<span class="keyword">const</span> <a class="code" href="classPredicate.html">Predicate</a>&amp; pred)
<a name="l00447"></a>00447         : groundPred_(pred), predValue_(false)
<a name="l00448"></a>00448     { <span class="comment">/* NOP */</span> }
<a name="l00449"></a>00449 
<a name="l00450"></a><a class="code" href="classPredicateGroundFeature.html#d8418f247510d781349f304e93e6f218">00450</a>     <span class="keyword">virtual</span> <a class="code" href="classPredicateGroundFeature.html#d8418f247510d781349f304e93e6f218">~PredicateGroundFeature</a>() { <span class="comment">/* NOP */</span> }
<a name="l00451"></a>00451 
<a name="l00452"></a><a class="code" href="classPredicateGroundFeature.html#510844c33563c0e0288277bd41a61ab8">00452</a>     <a class="code" href="classPredicate.html">Predicate</a>* <a class="code" href="classPredicateGroundFeature.html#510844c33563c0e0288277bd41a61ab8">getPredicate</a>() { <span class="keywordflow">return</span> &amp;groundPred_; }
<a name="l00453"></a><a class="code" href="classPredicateGroundFeature.html#ecf2d4012b140db1a5e45cc7b8ac54f6">00453</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classPredicateGroundFeature.html#ecf2d4012b140db1a5e45cc7b8ac54f6">computeValue</a>() { <span class="keywordflow">return</span> predValue_ ? 1.0 : 0.0; }
<a name="l00454"></a><a class="code" href="classPredicateGroundFeature.html#1b907ae51b4c886d1198c325acf7d68a">00454</a>     <span class="keywordtype">void</span> <a class="code" href="classPredicateGroundFeature.html#1b907ae51b4c886d1198c325acf7d68a">setValue</a>(<span class="keywordtype">bool</span> val)   
<a name="l00455"></a>00455     { 
<a name="l00456"></a>00456         <span class="keywordflow">if</span> (predValue_ != val) {
<a name="l00457"></a>00457             predValue_ = val; 
<a name="l00458"></a>00458             <a class="code" href="classGroundFeature.html#925fe3462f91580fde6448ba143196f7">setDirty</a>();  
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460     }
<a name="l00461"></a>00461 
<a name="l00462"></a><a class="code" href="classPredicateGroundFeature.html#9368817fef36a8b46d872eceff2f8680">00462</a>     <span class="keywordtype">void</span> <a class="code" href="classPredicateGroundFeature.html#9368817fef36a8b46d872eceff2f8680">setValueAndUpdate</a>(<span class="keywordtype">bool</span> val)
<a name="l00463"></a>00463     {
<a name="l00464"></a>00464         <span class="keywordflow">if</span> (predValue_ != val) {
<a name="l00465"></a>00465             predValue_ = val;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467             <span class="keywordflow">if</span> (val) {
<a name="l00468"></a>00468                 <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a> = 1.0;
<a name="l00469"></a>00469                 <a class="code" href="classGroundFeature.html#4212e0c6b913e0c1e5e1b55271fe5d1f">updateParents</a>(0.0, 1.0);
<a name="l00470"></a>00470             } <span class="keywordflow">else</span> {
<a name="l00471"></a>00471                 <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a> = 0.0;
<a name="l00472"></a>00472                 <a class="code" href="classGroundFeature.html#4212e0c6b913e0c1e5e1b55271fe5d1f">updateParents</a>(1.0, 0.0);
<a name="l00473"></a>00473             }
<a name="l00474"></a>00474         }
<a name="l00475"></a>00475     }
<a name="l00476"></a>00476 
<a name="l00477"></a><a class="code" href="classPredicateGroundFeature.html#ec81d468a6ac79850801827b352d1731">00477</a>     <span class="keywordtype">void</span> <a class="code" href="classPredicateGroundFeature.html#ec81d468a6ac79850801827b352d1731">setValueAndUpdateCounts</a>(<span class="keywordtype">bool</span> val)
<a name="l00478"></a>00478     {
<a name="l00479"></a>00479         <span class="keywordflow">if</span> (predValue_ != val) {
<a name="l00480"></a>00480             predValue_ = val;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482             <span class="keywordflow">if</span> (val) {
<a name="l00483"></a>00483                 <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a> = 1.0;
<a name="l00484"></a>00484                 <a class="code" href="classGroundFeature.html#1085873599a045fd2441ebb3e61e6f8c">updateParentCounts</a>(0.0, 1.0);
<a name="l00485"></a>00485             } <span class="keywordflow">else</span> {
<a name="l00486"></a>00486                 <a class="code" href="classGroundFeature.html#fe6b5471b3333845983ead131c2a5708">cachedValue_</a> = 0.0;
<a name="l00487"></a>00487                 <a class="code" href="classGroundFeature.html#1085873599a045fd2441ebb3e61e6f8c">updateParentCounts</a>(1.0, 0.0);
<a name="l00488"></a>00488             }
<a name="l00489"></a>00489         }
<a name="l00490"></a>00490     }
<a name="l00491"></a>00491 
<a name="l00492"></a><a class="code" href="classPredicateGroundFeature.html#956826d487c576ec7ad3f2b58cdca2ec">00492</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classPredicateGroundFeature.html#956826d487c576ec7ad3f2b58cdca2ec">computePartialDeriv</a>(<span class="keywordtype">int</span> featureIndex, <span class="keywordtype">int</span> weightIndex) 
<a name="l00493"></a>00493         { <span class="keywordflow">return</span> 0; }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 <span class="keyword">private</span>:
<a name="l00496"></a>00496     <a class="code" href="classPredicate.html">Predicate</a> groundPred_;
<a name="l00497"></a>00497     <span class="keywordtype">bool</span> predValue_;
<a name="l00498"></a>00498 };
<a name="l00499"></a>00499 
<a name="l00500"></a>00500 
<a name="l00501"></a><a class="code" href="classPredicateFeature.html#566d2be9771aea7ffe4c9669fd7379ec">00501</a> <span class="keyword">inline</span> <a class="code" href="classGroundFeature.html">GroundFeature</a>* <a class="code" href="classPredicateFeature.html#566d2be9771aea7ffe4c9669fd7379ec">PredicateFeature::constructGroundFeature</a>(
<a name="l00502"></a>00502         <a class="code" href="classGroundRRF.html">GroundRRF</a>* rrf, <span class="keyword">const</span> <a class="code" href="classArray.html">Array&lt;int&gt;</a>&amp; grounding, <a class="code" href="classDatabase.html">Database</a>* db)
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504     <a class="code" href="classPredicateGroundFeature.html">PredicateGroundFeature</a>* ret = <span class="keyword">new</span> <a class="code" href="classPredicateGroundFeature.html">PredicateGroundFeature</a>(pred_);
<a name="l00505"></a>00505     ret-&gt;<a class="code" href="classPredicateGroundFeature.html#1b907ae51b4c886d1198c325acf7d68a">setValue</a>(<a class="code" href="classPredicateFeature.html#d7f9e364bff97649005a0b3133076a86">computeValue</a>(grounding, db));
<a name="l00506"></a>00506     <span class="keywordflow">return</span> ret;
<a name="l00507"></a>00507 }
<a name="l00508"></a>00508 
<a name="l00509"></a><a class="code" href="classConstantGroundFeature.html">00509</a> <span class="keyword">class </span><a class="code" href="classConstantGroundFeature.html">ConstantGroundFeature</a> : <span class="keyword">public</span> <a class="code" href="classGroundFeature.html">GroundFeature</a>
<a name="l00510"></a>00510 {
<a name="l00511"></a>00511 <span class="keyword">public</span>:
<a name="l00512"></a><a class="code" href="classConstantGroundFeature.html#4b7b368758727596e86a3f7d1a8af310">00512</a>     <a class="code" href="classConstantGroundFeature.html#4b7b368758727596e86a3f7d1a8af310">ConstantGroundFeature</a>(<span class="keywordtype">double</span> value)
<a name="l00513"></a>00513         : <a class="code" href="classConstantGroundFeature.html#7f628cd7fb3713fabd97c75cfa0d078a">val_</a>(value)
<a name="l00514"></a>00514     { <span class="comment">/* NOP */</span> }
<a name="l00515"></a>00515 
<a name="l00516"></a><a class="code" href="classConstantGroundFeature.html#38ed155317f7b5e0d66bcc3c4683cb9b">00516</a>     <span class="keyword">virtual</span> <a class="code" href="classConstantGroundFeature.html#38ed155317f7b5e0d66bcc3c4683cb9b">~ConstantGroundFeature</a>() { <span class="comment">/* NOP */</span> }
<a name="l00517"></a>00517 
<a name="l00518"></a><a class="code" href="classConstantGroundFeature.html#7bff8e250f367a785fce776896a41e54">00518</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classConstantGroundFeature.html#7bff8e250f367a785fce776896a41e54">computeValue</a>() { <span class="keywordflow">return</span> <a class="code" href="classConstantGroundFeature.html#7f628cd7fb3713fabd97c75cfa0d078a">val_</a>; }
<a name="l00519"></a><a class="code" href="classConstantGroundFeature.html#c43dfa499aa019bdea9b6a637a341935">00519</a>     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classConstantGroundFeature.html#c43dfa499aa019bdea9b6a637a341935">computePartialDeriv</a>(<span class="keywordtype">int</span> featureIndex, <span class="keywordtype">int</span> weightIndex) 
<a name="l00520"></a>00520         { <span class="keywordflow">return</span> 0; }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522 <span class="keyword">protected</span>:
<a name="l00523"></a><a class="code" href="classConstantGroundFeature.html#7f628cd7fb3713fabd97c75cfa0d078a">00523</a>     <span class="keywordtype">double</span> <a class="code" href="classConstantGroundFeature.html#7f628cd7fb3713fabd97c75cfa0d078a">val_</a>;
<a name="l00524"></a>00524 };
<a name="l00525"></a>00525 
<a name="l00526"></a><a class="code" href="classConstantFeature.html#5c6e35de28adbe7ed08f5743de6d84e6">00526</a> <span class="keyword">inline</span> <a class="code" href="classGroundFeature.html">GroundFeature</a>* <a class="code" href="classConstantFeature.html#5c6e35de28adbe7ed08f5743de6d84e6">ConstantFeature::constructGroundFeature</a>(
<a name="l00527"></a>00527         <a class="code" href="classGroundRRF.html">GroundRRF</a>* rrf, <span class="keyword">const</span> <a class="code" href="classArray.html">Array&lt;int&gt;</a>&amp; grounding, <a class="code" href="classDatabase.html">Database</a>* db) 
<a name="l00528"></a>00528 {
<a name="l00529"></a>00529     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classConstantGroundFeature.html">ConstantGroundFeature</a>(value_);
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 
<a name="l00532"></a><a class="code" href="classGroundRRF.html">00532</a> <span class="keyword">class </span><a class="code" href="classGroundRRF.html">GroundRRF</a>
<a name="l00533"></a>00533 {
<a name="l00534"></a>00534 <span class="keyword">public</span>:
<a name="l00535"></a>00535     <a class="code" href="classGroundRRF.html#2eae97e55d1c94e505fbfa83f67a671b">GroundRRF</a>(<a class="code" href="classRRF.html">RRF</a>* rrf, <a class="code" href="classDatabase.html">Database</a>* db);
<a name="l00536"></a>00536 
<a name="l00537"></a><a class="code" href="classGroundRRF.html#14ae41019c1d9b08af4398bba17d2a6c">00537</a>     <span class="keywordtype">double</span> <a class="code" href="classGroundRRF.html#14ae41019c1d9b08af4398bba17d2a6c">getValue</a>() { <span class="keywordflow">return</span> root_-&gt;<a class="code" href="classGroundFeature.html#b49169ec24a6f028b1cf24040198f85c">getValue</a>(); }
<a name="l00538"></a>00538 
<a name="l00539"></a><a class="code" href="classGroundRRF.html#91a55e7025468ae51e3a3da15b2b3537">00539</a>     <span class="keywordtype">double</span> <a class="code" href="classGroundRRF.html#91a55e7025468ae51e3a3da15b2b3537">getLogValue</a>() { <span class="keywordflow">return</span> root_-&gt;<a class="code" href="classGroundFeature.html#4312cfdd326ed93cb22bd71f74161689">getLogValue</a>(); }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     <span class="comment">// DEBUG</span>
<a name="l00542"></a>00542     <span class="comment">//double getLogPseudoLikelihood(const Array&lt;int&gt;&amp; queryPreds, const Domain* domain);</span>
<a name="l00543"></a>00543     <span class="keywordtype">double</span> <a class="code" href="classGroundRRF.html#7f680b763da4af438505cfac404038e0">getLogPseudoLikelihood</a>(<span class="keyword">const</span> <a class="code" href="classArray.html">Array&lt;int&gt;</a>&amp; queryPreds);
<a name="l00544"></a>00544     <span class="keywordtype">double</span> <a class="code" href="classGroundRRF.html#7f680b763da4af438505cfac404038e0">getLogPseudoLikelihood</a>(<span class="keyword">const</span> <a class="code" href="classArray.html">Array&lt;Predicate*&gt;</a>&amp; queryPreds);
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     <span class="keywordtype">void</span> <a class="code" href="classGroundRRF.html#bc3c92f48cf2f35b40b6fb47e76f8b9d">getCounts</a>(<a class="code" href="classArray.html">Array&lt;double&gt;</a>&amp; counts<span class="comment">/*, Database* db*/</span>);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <span class="keywordtype">void</span> <a class="code" href="classGroundRRF.html#5e611f8eb34e5761529d674507307ada">getPseudoCounts</a>(<a class="code" href="classArray.html">Array&lt;double&gt;</a>&amp; counts, <span class="keyword">const</span> <a class="code" href="classArray.html">Array&lt;int&gt;</a>&amp; queryPreds,
<a name="l00549"></a>00549             <span class="keywordtype">double</span> samplingFrac);
<a name="l00550"></a>00550     <span class="keywordtype">void</span> <a class="code" href="classGroundRRF.html#c3979f1634d5db1caf6c30c428c8b517">getPseudoCountsFast</a>(<a class="code" href="classArray.html">Array&lt;double&gt;</a>&amp; counts, 
<a name="l00551"></a>00551             <span class="keyword">const</span> <a class="code" href="classArray.html">Array&lt;int&gt;</a>&amp; queryPreds, <span class="keywordtype">double</span> samplingFrac);
<a name="l00552"></a>00552 
<a name="l00553"></a><a class="code" href="classGroundRRF.html#f78ea12d4dd0a9db2e4482949a991204">00553</a>     <span class="keywordtype">int</span> <a class="code" href="classGroundRRF.html#f78ea12d4dd0a9db2e4482949a991204">getNumPredicateGroundings</a>(<span class="keywordtype">int</span> predIdx) {
<a name="l00554"></a>00554         <span class="comment">// NOTE: assuming that predicate 0 is equality and therefore skipped,</span>
<a name="l00555"></a>00555         <span class="comment">// and that predicates appear first.  This could be wrong.</span>
<a name="l00556"></a>00556         <span class="keywordflow">return</span> allFeatures_[predIdx-1].<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>();
<a name="l00557"></a>00557     }
<a name="l00558"></a>00558 
<a name="l00559"></a><a class="code" href="classGroundRRF.html#c8b0d4e66ae8a71e65316401e0c5cf49">00559</a>     <span class="keywordtype">bool</span> <a class="code" href="classGroundRRF.html#c8b0d4e66ae8a71e65316401e0c5cf49">getPredicateValue</a>(<span class="keywordtype">int</span> predIdx, <span class="keywordtype">int</span> groundIdx) {
<a name="l00560"></a>00560         <span class="comment">// NOTE: assuming that predicate 0 is equality and therefore skipped,</span>
<a name="l00561"></a>00561         <span class="comment">// and that predicates appear first.  This could be wrong.</span>
<a name="l00562"></a>00562         <span class="keywordflow">if</span> (allFeatures_[predIdx-1][groundIdx] != NULL) {
<a name="l00563"></a>00563             <span class="keywordflow">return</span> (((<a class="code" href="classPredicateGroundFeature.html">PredicateGroundFeature</a>*)allFeatures_[predIdx-1][groundIdx])
<a name="l00564"></a>00564                 -&gt;<a class="code" href="classGroundRRF.html#14ae41019c1d9b08af4398bba17d2a6c">getValue</a>() != 0.0);
<a name="l00565"></a>00565         } <span class="keywordflow">else</span> {
<a name="l00566"></a>00566             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00567"></a>00567         }
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569 
<a name="l00570"></a><a class="code" href="classGroundRRF.html#e5e67775b1273ce2c67cd0d3868404a0">00570</a>     <span class="keywordtype">void</span> <a class="code" href="classGroundRRF.html#e5e67775b1273ce2c67cd0d3868404a0">setPredicateValue</a>(<span class="keywordtype">int</span> predIdx, <span class="keywordtype">int</span> groundIdx, <span class="keywordtype">bool</span> value) {
<a name="l00571"></a>00571         <span class="comment">// NOTE: assuming that predicate 0 is equality and therefore skipped,</span>
<a name="l00572"></a>00572         <span class="comment">// and that predicates appear first.  This could be wrong.</span>
<a name="l00573"></a>00573 
<a name="l00574"></a>00574         <span class="keywordflow">if</span> (allFeatures_[predIdx-1][groundIdx] != NULL) {
<a name="l00575"></a>00575             ((<a class="code" href="classPredicateGroundFeature.html">PredicateGroundFeature</a>*)allFeatures_[predIdx-1][groundIdx])
<a name="l00576"></a>00576                 -&gt;setValue(value);
<a name="l00577"></a>00577         }
<a name="l00578"></a>00578     }
<a name="l00579"></a>00579 
<a name="l00580"></a><a class="code" href="classGroundRRF.html#922f72ffa7d5d2c005da9f026eb923cd">00580</a>     <span class="keywordtype">void</span> <a class="code" href="classGroundRRF.html#922f72ffa7d5d2c005da9f026eb923cd">setPredicateAndUpdate</a>(<span class="keywordtype">int</span> predIdx, <span class="keywordtype">int</span> groundIdx, <span class="keywordtype">bool</span> value) {
<a name="l00581"></a>00581         <span class="comment">// NOTE: assuming that predicate 0 is equality and therefore skipped,</span>
<a name="l00582"></a>00582         <span class="comment">// and that predicates appear first.  This could be wrong.</span>
<a name="l00583"></a>00583         <span class="keywordflow">if</span> (allFeatures_[predIdx-1][groundIdx] != NULL) {
<a name="l00584"></a>00584             ((<a class="code" href="classPredicateGroundFeature.html">PredicateGroundFeature</a>*)allFeatures_[predIdx-1][groundIdx])
<a name="l00585"></a>00585                 -&gt;setValueAndUpdate(value);
<a name="l00586"></a>00586                 <span class="comment">//-&gt;setValue(value);</span>
<a name="l00587"></a>00587         }
<a name="l00588"></a>00588     }
<a name="l00589"></a>00589 
<a name="l00590"></a><a class="code" href="classGroundRRF.html#a192f5d92506615f8c0e5cacf70da8d4">00590</a>     <span class="keywordtype">void</span> <a class="code" href="classGroundRRF.html#a192f5d92506615f8c0e5cacf70da8d4">setPredicateAndUpdateCounts</a>(<span class="keywordtype">int</span> predIdx, <span class="keywordtype">int</span> groundIdx, <span class="keywordtype">bool</span> value) {
<a name="l00591"></a>00591         <span class="comment">// NOTE: assuming that predicate 0 is equality and therefore skipped,</span>
<a name="l00592"></a>00592         <span class="comment">// and that predicates appear first.  This could be wrong.</span>
<a name="l00593"></a>00593         <span class="keywordflow">if</span> (allFeatures_[predIdx-1][groundIdx] != NULL) {
<a name="l00594"></a>00594             ((<a class="code" href="classPredicateGroundFeature.html">PredicateGroundFeature</a>*)allFeatures_[predIdx-1][groundIdx])
<a name="l00595"></a>00595                 -&gt;setValueAndUpdateCounts(value);
<a name="l00596"></a>00596         } <span class="keywordflow">else</span> {
<a name="l00597"></a>00597             <span class="comment">// HACK DEBUG</span>
<a name="l00598"></a>00598             cout &lt;&lt; <span class="stringliteral">"Feature was NULL! Possible bug.\n"</span>;
<a name="l00599"></a>00599         }
<a name="l00600"></a>00600     }
<a name="l00601"></a>00601 
<a name="l00602"></a><a class="code" href="classGroundRRF.html#44a32acbe7ba85ff3c89559a30971495">00602</a>     <a class="code" href="classGroundFeature.html">GroundFeature</a>* <a class="code" href="classGroundRRF.html#44a32acbe7ba85ff3c89559a30971495">getGroundFeature</a>(<a class="code" href="classFeature.html">Feature</a>* feature, <a class="code" href="classArray.html">Array&lt;int&gt;</a>&amp; grounding)
<a name="l00603"></a>00603     {
<a name="l00604"></a>00604         <span class="keywordtype">int</span> featureIdx = feature-&gt;<a class="code" href="classFeature.html#e9acf2ede80f4c8cadb5ad78ef61f3ba">getId</a>();
<a name="l00605"></a>00605         <span class="keywordtype">int</span> groundIdx  = feature-&gt;<a class="code" href="classFeature.html#025e3132c82defff75695b01f664b1d4">getGroundingIndex</a>(grounding, db_);
<a name="l00606"></a>00606 
<a name="l00607"></a>00607         <span class="keywordflow">while</span> (allFeatures_[featureIdx].size() &lt;= groundIdx) {
<a name="l00608"></a>00608             allFeatures_[featureIdx].<a class="code" href="classArray.html#752db599431d93ee14c5b0f7b05ba03a">append</a>((<a class="code" href="classGroundFeature.html">GroundFeature</a>*)NULL);
<a name="l00609"></a>00609         }
<a name="l00610"></a>00610 
<a name="l00611"></a>00611         <span class="keywordflow">if</span> (allFeatures_[featureIdx][groundIdx] == NULL) {
<a name="l00612"></a>00612             allFeatures_[featureIdx][groundIdx] 
<a name="l00613"></a>00613                 = feature-&gt;<a class="code" href="classFeature.html#733cdb34124d3fffc0b6df47711c93b8">constructGroundFeature</a>(<span class="keyword">this</span>, grounding, db_);
<a name="l00614"></a>00614         }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616         <span class="keywordflow">return</span> allFeatures_[featureIdx][groundIdx];
<a name="l00617"></a>00617     }
<a name="l00618"></a>00618 
<a name="l00619"></a><a class="code" href="classGroundRRF.html#fad9ad057c838ca30a10d82ab06aae80">00619</a>     <span class="keywordtype">int</span> <a class="code" href="classGroundRRF.html#fad9ad057c838ca30a10d82ab06aae80">getNumGroundings</a>(<span class="keywordtype">int</span> featureId)<span class="keyword"> const </span>{
<a name="l00620"></a>00620         <span class="keywordflow">return</span> allFeatures_[featureId].<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>();
<a name="l00621"></a>00621     }
<a name="l00622"></a>00622 
<a name="l00623"></a><a class="code" href="classGroundRRF.html#e038b30d3dabc6d163f1912753b6694a">00623</a>     <span class="keywordtype">void</span> <a class="code" href="classGroundRRF.html#e038b30d3dabc6d163f1912753b6694a">dirtyAll</a>() {
<a name="l00624"></a>00624         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; allFeatures_.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); i++) {
<a name="l00625"></a>00625             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; allFeatures_[i].<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); j++) {
<a name="l00626"></a>00626                 <span class="keywordflow">if</span> (allFeatures_[i][j] != NULL) {
<a name="l00627"></a>00627                     allFeatures_[i][j]-&gt;setDirty();
<a name="l00628"></a>00628                 }
<a name="l00629"></a>00629             }
<a name="l00630"></a>00630         }
<a name="l00631"></a>00631     }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 <span class="keyword">private</span>:
<a name="l00634"></a>00634     <a class="code" href="classGroundFeature.html">GroundFeature</a>* root_;
<a name="l00635"></a>00635     <a class="code" href="classRRF.html">RRF</a>* rrf_;
<a name="l00636"></a>00636     <a class="code" href="classDatabase.html">Database</a>* db_;
<a name="l00637"></a>00637     <span class="keywordtype">int</span> numCounts_;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639     <a class="code" href="classArray.html">Array&lt;Array&lt;GroundFeature*&gt;</a> &gt; allFeatures_;
<a name="l00640"></a>00640 };
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 
<a name="l00643"></a><a class="code" href="classRecursiveFeature.html#cbf70f484e12a159307ea7a7048471aa">00643</a> <span class="keyword">inline</span> <a class="code" href="classGroundFeature.html">GroundFeature</a>* <a class="code" href="classRecursiveFeature.html#cbf70f484e12a159307ea7a7048471aa">RecursiveFeature::constructGroundFeature</a>(
<a name="l00644"></a>00644         <a class="code" href="classGroundRRF.html">GroundRRF</a>* rrf, <span class="keyword">const</span> <a class="code" href="classArray.html">Array&lt;int&gt;</a>&amp; grounding, <a class="code" href="classDatabase.html">Database</a>* db) 
<a name="l00645"></a>00645 {
<a name="l00646"></a>00646     <a class="code" href="classRecursiveGroundFeature.html">RecursiveGroundFeature</a>* ret = <span class="keyword">new</span> <a class="code" href="classRecursiveGroundFeature.html">RecursiveGroundFeature</a>(
<a name="l00647"></a>00647             <span class="keyword">this</span>, <a class="code" href="classRecursiveFeature.html#6fc9c94b175d8ca5978ddb03fa28038a">doDerivsOfLog_</a>);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649     <span class="keywordflow">if</span> (<a class="code" href="classRecursiveFeature.html#788342a9c03f0c8385e0526241e8ace7">numGroundings_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>() == 0) {
<a name="l00650"></a>00650         <a class="code" href="classRecursiveFeature.html#5bc00492ad557419504db299ae51cac5">cacheNumGroundings</a>(db);
<a name="l00651"></a>00651     }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     <span class="comment">// Add all children (recurses as necessary)</span>
<a name="l00654"></a>00654     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classRecursiveFeature.html#a542c6debbc4006f86ab6b2683a076a5">getNumChildren</a>(); i++) {
<a name="l00655"></a>00655 
<a name="l00656"></a>00656         <a class="code" href="classArray.html">Array&lt;int&gt;</a> childGrounding;
<a name="l00657"></a>00657         <a class="code" href="classArraysAccessor.html">ArraysAccessor&lt;int&gt;</a>* groundingIter = 
<a name="l00658"></a>00658             <a class="code" href="classRecursiveFeature.html#3960199ad96148731ab834393ea39692">getChildGroundingIter</a>(i, grounding, db);
<a name="l00659"></a>00659 
<a name="l00660"></a>00660         <span class="keywordflow">do</span> {
<a name="l00661"></a>00661             groundingIter-&gt;<a class="code" href="classArraysAccessor.html#f94c9e750cd473549118a247c12b35ae">getNextCombination</a>(childGrounding);
<a name="l00662"></a>00662             ret-&gt;<a class="code" href="classRecursiveGroundFeature.html#3f742274ab9787f5b45a9e4310135553">addChild</a>(i, rrf-&gt;<a class="code" href="classGroundRRF.html#44a32acbe7ba85ff3c89559a30971495">getGroundFeature</a>(<a class="code" href="classRecursiveFeature.html#ad71b1776764648a7291fba385348a4f">children_</a>[i], 
<a name="l00663"></a>00663                         childGrounding));
<a name="l00664"></a>00664         } <span class="keywordflow">while</span> (groundingIter-&gt;<a class="code" href="classArraysAccessor.html#918e7f43b7168775cc0a56daf10997e4">hasNextCombination</a>());
<a name="l00665"></a>00665 
<a name="l00666"></a>00666         <a class="code" href="classRecursiveFeature.html#8e7e75b01c5255de923d6db986af1ef0">releaseChildGroundingIter</a>(i, groundingIter);
<a name="l00667"></a>00667     }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669     <span class="keywordflow">return</span> ret;
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a><a class="code" href="classClausalFeature.html#50396ce51284d45db316fb6858bf8082">00672</a> <span class="keyword">inline</span> <a class="code" href="classGroundFeature.html">GroundFeature</a>*  <a class="code" href="classClausalFeature.html#50396ce51284d45db316fb6858bf8082">ClausalFeature::constructGroundFeature</a>(
<a name="l00673"></a>00673         <a class="code" href="classGroundRRF.html">GroundRRF</a>* rrf, <span class="keyword">const</span> <a class="code" href="classArray.html">Array&lt;int&gt;</a>&amp; grounding, <a class="code" href="classDatabase.html">Database</a>* db) 
<a name="l00674"></a>00674 {
<a name="l00675"></a>00675     <a class="code" href="classClausalGroundFeature.html">ClausalGroundFeature</a>* ret = <span class="keyword">new</span> <a class="code" href="classClausalGroundFeature.html">ClausalGroundFeature</a>(<span class="keyword">this</span>);
<a name="l00676"></a>00676 
<a name="l00677"></a>00677     <span class="comment">// Add all children (recurses as necessary)</span>
<a name="l00678"></a>00678     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classRecursiveFeature.html#a542c6debbc4006f86ab6b2683a076a5">getNumChildren</a>(); i++) {
<a name="l00679"></a>00679 
<a name="l00680"></a>00680         <a class="code" href="classArray.html">Array&lt;int&gt;</a> childGrounding;
<a name="l00681"></a>00681         <a class="code" href="classArraysAccessor.html">ArraysAccessor&lt;int&gt;</a>* groundingIter = 
<a name="l00682"></a>00682             <a class="code" href="classRecursiveFeature.html#3960199ad96148731ab834393ea39692">getChildGroundingIter</a>(i, grounding, db);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684         <span class="keywordflow">do</span> {
<a name="l00685"></a>00685             groundingIter-&gt;<a class="code" href="classArraysAccessor.html#f94c9e750cd473549118a247c12b35ae">getNextCombination</a>(childGrounding);
<a name="l00686"></a>00686             ret-&gt;<a class="code" href="classRecursiveGroundFeature.html#3f742274ab9787f5b45a9e4310135553">addChild</a>(i, rrf-&gt;<a class="code" href="classGroundRRF.html#44a32acbe7ba85ff3c89559a30971495">getGroundFeature</a>(<a class="code" href="classRecursiveFeature.html#ad71b1776764648a7291fba385348a4f">children_</a>[i], 
<a name="l00687"></a>00687                         childGrounding));
<a name="l00688"></a>00688         } <span class="keywordflow">while</span> (groundingIter-&gt;<a class="code" href="classArraysAccessor.html#918e7f43b7168775cc0a56daf10997e4">hasNextCombination</a>());
<a name="l00689"></a>00689 
<a name="l00690"></a>00690         <a class="code" href="classRecursiveFeature.html#8e7e75b01c5255de923d6db986af1ef0">releaseChildGroundingIter</a>(i, groundingIter);
<a name="l00691"></a>00691     }
<a name="l00692"></a>00692 
<a name="l00693"></a>00693     <span class="keywordflow">return</span> ret;
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696 
<a name="l00697"></a><a class="code" href="classGroundFeature.html#88545bfad2c34f9af3f0c8897e0dc670">00697</a> <span class="keywordtype">double</span> <a class="code" href="classGroundFeature.html#88545bfad2c34f9af3f0c8897e0dc670">GroundFeature::getDeriv</a>() 
<a name="l00698"></a>00698 {
<a name="l00699"></a>00699     <span class="keywordflow">if</span> (<a class="code" href="classGroundFeature.html#31a533ff1b3c471327b542499c1a25a6">dirtyDeriv_</a>) {
<a name="l00700"></a>00700         <span class="keywordflow">if</span> (<a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>() == 0) {
<a name="l00701"></a>00701             <a class="code" href="classGroundFeature.html#94858a4e98d9f8adc435d6210095665f">cachedDeriv_</a> = 1.0;
<a name="l00702"></a>00702         } <span class="keywordflow">else</span> {
<a name="l00703"></a>00703             <a class="code" href="classGroundFeature.html#94858a4e98d9f8adc435d6210095665f">cachedDeriv_</a> = 0.0;
<a name="l00704"></a>00704             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); i++) {
<a name="l00705"></a>00705                 <a class="code" href="classGroundFeature.html#94858a4e98d9f8adc435d6210095665f">cachedDeriv_</a> += <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>[i]-&gt;<a class="code" href="classGroundFeature.html#88545bfad2c34f9af3f0c8897e0dc670">getDeriv</a>()
<a name="l00706"></a>00706                     * <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>[i]-&gt;getChildDeriv(<a class="code" href="classGroundFeature.html#e4c8f628b191ba453d5491a56b365a15">parentIndices_</a>[i]);
<a name="l00707"></a>00707             }
<a name="l00708"></a>00708         }
<a name="l00709"></a>00709         <a class="code" href="classGroundFeature.html#31a533ff1b3c471327b542499c1a25a6">dirtyDeriv_</a> = <span class="keyword">false</span>;
<a name="l00710"></a>00710     }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <span class="keywordflow">return</span> <a class="code" href="classGroundFeature.html#94858a4e98d9f8adc435d6210095665f">cachedDeriv_</a>;
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 
<a name="l00715"></a><a class="code" href="classGroundFeature.html#925fe3462f91580fde6448ba143196f7">00715</a> <span class="keywordtype">void</span> <a class="code" href="classGroundFeature.html#925fe3462f91580fde6448ba143196f7">GroundFeature::setDirty</a>()
<a name="l00716"></a>00716 { 
<a name="l00717"></a>00717     <span class="keywordflow">if</span> (!<a class="code" href="classGroundFeature.html#31a533ff1b3c471327b542499c1a25a6">dirtyDeriv_</a> || !<a class="code" href="classGroundFeature.html#0c60603d75a0824da112a81772ab3219">dirtyValue_</a> || !<a class="code" href="classGroundFeature.html#043125ddcec2b9befd1eca5d4a7b6fd2">dirtyLogValue_</a>) {
<a name="l00718"></a>00718         <a class="code" href="classGroundFeature.html#31a533ff1b3c471327b542499c1a25a6">dirtyDeriv_</a> = <span class="keyword">true</span>; 
<a name="l00719"></a>00719         <a class="code" href="classGroundFeature.html#0c60603d75a0824da112a81772ab3219">dirtyValue_</a> = <span class="keyword">true</span>;
<a name="l00720"></a>00720         <a class="code" href="classGroundFeature.html#043125ddcec2b9befd1eca5d4a7b6fd2">dirtyLogValue_</a> = <span class="keyword">true</span>;
<a name="l00721"></a>00721         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); i++) {
<a name="l00722"></a>00722             <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>[i]-&gt;<a class="code" href="classGroundFeature.html#925fe3462f91580fde6448ba143196f7">setDirty</a>();
<a name="l00723"></a>00723         }
<a name="l00724"></a>00724     }
<a name="l00725"></a>00725 }
<a name="l00726"></a>00726 
<a name="l00727"></a><a class="code" href="classGroundFeature.html#4212e0c6b913e0c1e5e1b55271fe5d1f">00727</a> <span class="keywordtype">void</span> <a class="code" href="classGroundFeature.html#4212e0c6b913e0c1e5e1b55271fe5d1f">GroundFeature::updateParents</a>(<span class="keywordtype">double</span> oldValue, <span class="keywordtype">double</span> newValue)
<a name="l00728"></a>00728 {
<a name="l00729"></a>00729     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); i++) {
<a name="l00730"></a>00730         <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>[i]-&gt;update(<a class="code" href="classGroundFeature.html#e4c8f628b191ba453d5491a56b365a15">parentIndices_</a>[i], oldValue, newValue);
<a name="l00731"></a>00731     }
<a name="l00732"></a>00732 }
<a name="l00733"></a>00733 
<a name="l00734"></a><a class="code" href="classGroundFeature.html#1085873599a045fd2441ebb3e61e6f8c">00734</a> <span class="keywordtype">void</span> <a class="code" href="classGroundFeature.html#1085873599a045fd2441ebb3e61e6f8c">GroundFeature::updateParentCounts</a>(<span class="keywordtype">double</span> oldValue, <span class="keywordtype">double</span> newValue)
<a name="l00735"></a>00735 {
<a name="l00736"></a>00736     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>.<a class="code" href="classArray.html#d7a2ae7ae5e0d02cd7d4d9e2f696379e">size</a>(); i++) {
<a name="l00737"></a>00737         <a class="code" href="classGroundFeature.html#365c3fe717a9d544589d33584b304515">parents_</a>[i]-&gt;updateCounts(<a class="code" href="classGroundFeature.html#e4c8f628b191ba453d5491a56b365a15">parentIndices_</a>[i], oldValue, newValue);
<a name="l00738"></a>00738     }
<a name="l00739"></a>00739 }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741 <span class="preprocessor">#endif // ndef GFEATURE_H_APR_06</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Feb 14 15:15:20 2007 for Alchemy by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1 </small></address>
</body>
</html>
